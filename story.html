<!DOCTYPE html>
<html lang="nl">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MJ1V2PREL6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MJ1V2PREL6');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schrijfsel — Pieter Paul Tybbe</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<header id="main-header">
    <nav id="main-nav"></nav>
</header>

<main class="reader">
    <h1 id="story-title" style="text-align: center; margin-top: 2rem; font-family: serif; color: #ffd166;"></h1>
    
    <article id="text-container" class="literary-text">Verhaal wordt geladen...</article>

    <div class="like-section" style="text-align: center; padding: 40px 0; border-top: 1px solid rgba(255, 209, 102, 0.1); margin-top: 40px;">
        <p style="font-style: italic; font-size: 1rem; margin-bottom: 15px; font-family: serif; color: white;">
            Laat weten wat je ervan vond!
        </p>
        <div id="like-container" style="min-height: 80px; display: flex; justify-content: center; align-items: center;"></div>
    </div>

    <section class="reader-feedback" style="margin-bottom: 50px;">
        <h2 style="color: #ffd166; font-family: serif;">Reacties</h2>
        <div id="cusdis_thread" 
             data-host="https://cusdis.com" 
             data-app-id="e2ce094f-0f93-4f5c-8ea9-f364505c967f" 
             data-lang="nl"
             data-theme="dark">
        </div>
    </section>

    <div style="text-align: center; margin: 40px 0;">
        <a href="index.html" style="color: #ffd166; text-decoration: none; font-variant: small-caps; border: 1px solid #ffd166; padding: 10px 20px;">
            ← Terug naar alle verhalen
        </a>
    </div>
</main>

<script src="data/stories.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Configuratie op basis van jouw screenshots
    const firebaseConfig = {
        apiKey: "AIzaSyB_J1Up8Uof5CXvPT4SQ30er20hL2Qy6Cw",
        authDomain: "sesjat-549da.firebaseapp.com",
        projectId: "sesjat-549da",
        storageBucket: "sesjat-549da.firebasestorage.app",
        messagingSenderId: "845325090016",
        appId: "1:845325090016:web:358412e188aad787fee485",
        measurementId: "G-J8QZD6VXTX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function initPage() {
        const params = new URLSearchParams(window.location.search);
        const storyId = params.get("id");

        const textContainer = document.getElementById("text-container");
        const titleElement = document.getElementById("story-title");

        // Wacht tot de HTML elementen er zijn
        if (!textContainer || !titleElement) {
            setTimeout(initPage, 50);
            return;
        }

        const allStories = [
            ...(typeof stories !== 'undefined' ? stories : []), 
            ...(typeof archiveStories !== 'undefined' ? archiveStories : []),
            ...(typeof reviewStories !== 'undefined' ? reviewStories : [])
        ];
        
        const story = allStories.find(s => s.id === storyId);

        if (!story) {
            textContainer.innerText = "Verhaal niet gevonden.";
            return;
        }

        try {
            // 1. Tekst ophalen
            const res = await fetch(story.text);
            if (!res.ok) throw new Error("Tekstbestand niet gevonden");
            const htmlContent = await res.text();
            
            // 2. Titel invullen
            titleElement.innerText = story.title;
            document.title = `${story.title} | Pieter Paul Tybbe`;
            
            // 3. Formatteren
            let formattedContent = htmlContent;
            if (!htmlContent.includes('<p>') && !htmlContent.includes('<br>')) {
                formattedContent = htmlContent.split('\n').filter(l => l.trim()).map(l => `<p>${l}</p>`).join('');
            }
            textContainer.innerHTML = formattedContent;

            // 4. Likes initialiseren
            setupLikes(story.id);

        } catch (err) {
            console.error(err);
            textContainer.innerText = "Fout bij het laden van de tekst.";
        }
    }

    async function setupLikes(storyId) {
        const likeContainer = document.getElementById('like-container');
        if (!likeContainer) return;

        const docRef = doc(db, "likes", storyId);
        
        // De gouden rating-stijl die je vroeg
        likeContainer.innerHTML = `
            <div style="text-align:center; font-family: serif;">
                <button id="like-button" style="background:none; border:none; cursor:pointer; padding:0; transition: transform 0.2s;">
                    <i class="fa-solid fa-heart" style="color: #ebbb2d; font-size: 2.5rem;"></i>
                </button>
                <div id="like-count" style="color: #ebbb2d; font-size: 1.1rem; font-weight: bold; margin-top: 8px; letter-spacing: 1px;">...</div>
            </div>
        `;

        const likeBtn = document.getElementById('like-button');
        const countDisplay = document.getElementById('like-count');

        // Haal data op
        try {
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                countDisplay.innerText = snap.data().count;
            } else {
                countDisplay.innerText = "0";
                await setDoc(docRef, { count: 0 });
            }
        } catch (e) {
            console.error("Firestore error:", e);
            countDisplay.innerText = "0";
        }

        // Like actie
        likeBtn.onclick = async () => {
            likeBtn.style.transform = "scale(1.2)";
            setTimeout(() => likeBtn.style.transform = "scale(1)", 200);
            try {
                await updateDoc(docRef, { count: increment(1) });
                const newSnap = await getDoc(docRef);
                countDisplay.innerText = newSnap.data().count;
            } catch (e) {
                console.error("Update failed:", e);
            }
        };
    }

    // Start het script
    initPage();

    // Navigatie laden
    fetch('nav.html')
        .then(res => res.text())
        .then(data => {
            const nav = document.getElementById('main-nav');
            if (nav) nav.innerHTML = data;
        });
</script>

<script async defer src="https://cusdis.com/js/cusdis.es.js"></script>
</body>
</html>

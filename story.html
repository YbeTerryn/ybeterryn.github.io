<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB_J1Up8Uof5CXvPT4SQ30er20hL2Qy6Cw",
        authDomain: "sesjat-549da.firebaseapp.com",
        projectId: "sesjat-549da",
        storageBucket: "sesjat-549da.firebasestorage.app",
        messagingSenderId: "845325090016",
        appId: "1:845325090016:web:358412e188aad787fee485",
        measurementId: "G-J8QZD6VXTX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Hoofdfunctie
    async function renderStory() {
        const params = new URLSearchParams(window.location.search);
        const storyId = params.get("id");

        // 1. Zoek de HTML elementen
        const textContainer = document.getElementById("text-container");
        const titleElement = document.getElementById("story-title");

        if (!textContainer || !titleElement) {
            console.warn("Wachten op HTML elementen...");
            setTimeout(renderStory, 100); // Probeer het over 100ms opnieuw
            return;
        }

        // 2. Zoek de data
        const allStories = [
            ...(typeof stories !== 'undefined' ? stories : []), 
            ...(typeof archiveStories !== 'undefined' ? archiveStories : []),
            ...(typeof reviewStories !== 'undefined' ? reviewStories : [])
        ];
        
        const story = allStories.find(s => s.id === storyId);

        if (!story) {
            textContainer.innerHTML = "<p>Verhaal niet gevonden.</p>";
            return;
        }

        // 3. Laad de tekst
        try {
            const res = await fetch(story.text);
            if (!res.ok) throw new Error("Bestand niet gevonden");
            const htmlContent = await res.text();
            
            titleElement.innerText = story.title;
            document.title = `${story.title} | Pieter Paul Tybbe`;
            
            let formattedContent = htmlContent;
            if (!htmlContent.includes('<p>') && !htmlContent.includes('<br>')) {
                formattedContent = htmlContent.split('\n').filter(l => l.trim()).map(l => `<p>${l}</p>`).join('');
            }
            textContainer.innerHTML = formattedContent;

            // 4. Start likes
            setupLikes(story.id);

        } catch (err) {
            console.error("Fout bij laden:", err);
            textContainer.innerHTML = "<p>Er ging iets mis bij het laden van de tekst.</p>";
        }
    }

    async function setupLikes(storyId) {
        const likeContainer = document.getElementById('like-container');
        if (!likeContainer) return;

        const docRef = doc(db, "likes", storyId);
        
        likeContainer.innerHTML = `
            <div style="text-align:center; margin: 40px 0; font-family: serif;">
                <button id="like-button" style="background:none; border:none; cursor:pointer; padding:0; transition: transform 0.2s;">
                    <i class="fa-solid fa-heart" style="color: #ebbb2d; font-size: 2rem;"></i>
                </button>
                <div id="like-count" style="color: #ebbb2d; font-size: 1rem; font-weight: bold; margin-top: 8px; letter-spacing: 1px;">0</div>
            </div>
        `;

        const likeBtn = document.getElementById('like-button');
        const countDisplay = document.getElementById('like-count');

        try {
            const snap = await getDoc(docRef);
